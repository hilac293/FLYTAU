{% extends "base.html" %}

{% block title %}בחירת צוות{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
{% endblock %}

{% block content %}
<body>
  <div class="page">
    <div class="header">
      <h2>בחירת אנשי צוות</h2>
      <p>
        יש לבחור בדיוק
        <b>{{ required_attendants }}</b> דיילים ו־
        <b>{{ required_pilots }}</b> טייסים לטיסה
      </p>
    </div>

    <div class="card">
      {% if error %}
        <div class="notice error">{{ error }}</div>
      {% endif %}

      <form method="POST" action="/finalize-flight" id="crewForm">

        <!-- ================= ATTENDANTS SECTION ================= -->
        <div class="crew-section">
          <h3 class="section-title">דיילים</h3>
          <div class="small">בחר/י {{ required_attendants }} דיילים</div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>בחירה</th>
                  <th>ID</th>
                  <th>שם</th>
                  <th>הכשרה</th>
                  <th>תחילת עבודה</th>
                  <th>טיסה אחרונה - נחיתה</th>
                  <th>טיסה אחרונה - יעד</th>
                </tr>
              </thead>
              <tbody>
                {% for a in attendants %}
                <tr>
                  <td class="pick">
                    <input type="checkbox" class="attendant-box" name="attendant_ids" value="{{ a.attendant_id }}">
                  </td>
                  <td>{{ a.attendant_id }}</td>
                  <td>{{ a.full_name }}</td>
                  <td>{{ a.training_type }}</td>
                  <td>{{ a.start_date }}</td>
                  <td>{{ a.last_arrival if a.last_arrival else '-' }}</td>
                  <td>{{ a.last_destination if a.last_destination else '-' }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="notice" id="attNote" style="display:none;"></div>
        </div>

        <!-- ================= PILOTS SECTION ================= -->
        <div class="crew-section">
          <h3 class="section-title">טייסים</h3>
          <div class="small">בחר/י {{ required_pilots }} טייסים</div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>בחירה</th>
                  <th>ID</th>
                  <th>שם</th>
                  <th>הכשרה</th>
                  <th>תחילת עבודה</th>
                  <th>טיסה אחרונה - נחיתה</th>
                  <th>טיסה אחרונה - יעד</th>
                </tr>
              </thead>
              <tbody>
                {% for p in pilots %}
                <tr>
                  <td class="pick">
                    <input type="checkbox" class="pilot-box" name="pilot_ids" value="{{ p.pilot_id }}">
                  </td>
                  <td>{{ p.pilot_id }}</td>
                  <td>{{ p.full_name }}</td>
                  <td>{{ p.training_type }}</td>
                  <td>{{ p.start_date }}</td>
                  <td>{{ p.last_arrival if p.last_arrival else '-' }}</td>
                  <td>{{ p.last_destination if p.last_destination else '-' }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="notice" id="pilotNote" style="display:none;"></div>
        </div>

        <!-- ================= ACTIONS ================= -->
        <div class="actions_crew">
          <button class="btn btn-primary" type="submit">סיום יצירת טיסה</button>
          <a class="btn btn-ghost" href="/create-flight" style="text-decoration:none;display:inline-grid;place-items:center;">
            ביטול וחזרה
          </a>
        </div>

      </form>
    </div>
  </div>

<script>
  const requiredAtt = {{ required_attendants }};
  const requiredPil = {{ required_pilots }};

  const attBoxes = [...document.querySelectorAll(".attendant-box")];
  const pilBoxes = [...document.querySelectorAll(".pilot-box")];

  const attNote = document.getElementById("attNote");
  const pilNote = document.getElementById("pilotNote");

  function enforce(boxes, limit, note, label) {
    const count = boxes.filter(b => b.checked).length;
    if (count > limit) {
      boxes.filter(b => b.checked).pop().checked = false;
      return;
    }
    if (count < limit) {
      note.style.display = "block";
      note.textContent = `נבחרו ${count} מתוך ${limit} ${label}`;
    } else {
      note.style.display = "none";
    }
  }

  attBoxes.forEach(b => b.addEventListener("change", () => enforce(attBoxes, requiredAtt, attNote, "דיילים")));
  pilBoxes.forEach(b => b.addEventListener("change", () => enforce(pilBoxes, requiredPil, pilNote, "טייסים")));

  document.getElementById("crewForm").addEventListener("submit", (e) => {
    const ac = attBoxes.filter(b => b.checked).length;
    const pc = pilBoxes.filter(b => b.checked).length;
    if (ac !== requiredAtt || pc !== requiredPil) {
      e.preventDefault();
      attNote.style.display = "block";
      pilNote.style.display = "block";
      attNote.textContent = `חייב לבחור בדיוק ${requiredAtt} דיילים`;
      pilNote.textContent = `חייב לבחור בדיוק ${requiredPil} טייסים`;
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
  });
</script>

</body>
{% endblock %}
